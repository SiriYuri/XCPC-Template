```cpp
template<typename T = int>
struct PersistentTree {
    int n, s, cnt, MAXN;

    std::vector<T> tmp;
    std::vector<int> rt, le, ri, sz;

    PersistentTree(int n) : n(n), s(0), cnt(0), rt(n + 1, 0), MAXN(n * (log2(n) + 4)), tmp(n), le(MAXN + 5, 0), ri(MAXN + 5, 0), sz(MAXN + 5, 0) {}

    #define mid ((l + r) >> 1)

    void init(const std::vector<T> &a) {
        for (int i = 1; i <= n; ++i) {
            tmp[i - 1] = a[i];
        }
        std::ranges::sort(tmp);
        tmp.erase(unique(tmp.begin(), tmp.end()), tmp.end());
        s = tmp.size();
        rt.assign(n + 1, 0);
        rt[0] = build(1, s);
        for (int i = 1; i <= n; ++i) {
            int rk = idx(a[i]);
            rt[i] = insert(rt[i - 1], 1, s, rk);
        }
    }

    int build(int l, int r) {
        int p = ++cnt;
        sz[p] = 0;
        if (l < r) {
            le[p] = build(l, mid);
            ri[p] = build(mid + 1, r);
        } else {
            le[p] = ri[p] = 0;
        }
        return p;
    }

    int insert(int root, int l, int r, int rk) {
        int p = ++cnt;
        le[p] = le[root];
        ri[p] = ri[root];
        sz[p] = sz[root] + 1;
        if (l < r) {
            if (rk <= mid) {
                le[p] = insert(le[p], l, mid, rk);
            } else {
                ri[p] = insert(ri[p], mid + 1, r, rk);
            }
        }
        return p;
    }

    int query(int u, int v, int l, int r, int k) {
        if (l == r) return l;
        int d = sz[le[v]] - sz[le[u]];
        if (d >= k) {
            return query(le[u], le[v], l, mid, k);
        } else {
            return query(ri[u], ri[v], mid + 1, r, k - d);
        }
    }

    int idx(T x) {
        int L = 1, R = s, ans = 0;
        while (L <= R) {
        int m = (L + R) >> 1;
            if (tmp[m - 1] <= x) { 
                ans = m; L = m + 1; 
            } else {
                R = m - 1;
            }
        }
        return ans;
    }

    T kth(int l, int r, int k) {
        int idx = query(rt[l - 1], rt[r], 1, s, k);
        return tmp[idx - 1];
    }

  #undef mid
};

using KthTree = PersistentTree<int>;
```
